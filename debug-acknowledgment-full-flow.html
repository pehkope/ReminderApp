<!DOCTYPE html>
<html>
<head>
    <title>üîÑ Kuittauksen t√§ydellinen debug</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial; margin: 20px; }
        .step { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîÑ Kuittauksen t√§ydellinen debug ketju</h1>
    <div id="results"></div>
    
    <script>
        const NEW_API_URL = "https://script.google.com/macros/s/AKfycbxpQyWZkyiMXJIoJrHLEGZPOm-TgqBlW3ftSkmZTuDK6Ya-OZOlKkPW3RNTRQetNeNb/exec";
        const API_KEY = "reminder-tablet-2024";
        const CLIENT_ID = "mom";
        
        async function debugFullAcknowledgmentFlow() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>üîÑ Kuittauksen t√§ydellinen debug k√§ynniss√§...</h2>';
            
            try {
                // VAIHE 1: Hae alku tilanne
                console.log('üìã VAIHE 1: Hae alkutilanne...');
                const initialResponse = await fetch(`${NEW_API_URL}?clientID=${CLIENT_ID}&apiKey=${API_KEY}&_t=${Date.now()}`);
                const initialData = await initialResponse.json();
                
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>üìã VAIHE 1: Alkutilanne</h3>`;
                results.innerHTML += `<p><strong>Status:</strong> ${initialResponse.status}</p>`;
                
                if (initialData.dailyTasks) {
                    results.innerHTML += `<p><strong>L√∂ydettiin ${initialData.dailyTasks.length} teht√§v√§√§:</strong></p>`;
                    initialData.dailyTasks.forEach((task, index) => {
                        const ackStatus = task.isAckedToday ? "‚úÖ KUITATTU" : "‚ùå EI KUITATTU";
                        results.innerHTML += `<p>${index + 1}. <strong>${task.type}</strong>: "${task.description}" (${task.timeOfDay}) - ${ackStatus}</p>`;
                    });
                } else {
                    results.innerHTML += `<p style="color: red;">‚ùå Ei dailyTasks dataa!</p>`;
                }
                results.innerHTML += `</div>`;
                
                // Etsi RUOKA teht√§v√§ kuittaukseen
                const ruokaTask = initialData.dailyTasks?.find(task => task.type === "RUOKA");
                if (!ruokaTask) {
                    results.innerHTML += `<div class="step error">‚ùå Ei l√∂ytynyt RUOKA teht√§v√§√§ kuittaukseen!</div>`;
                    return;
                }
                
                console.log('üçΩÔ∏è L√∂ydettiin RUOKA teht√§v√§:', ruokaTask);
                
                // VAIHE 2: L√§het√§ kuittaus
                console.log('üì§ VAIHE 2: L√§het√§ kuittaus...');
                const ackPayload = {
                    clientID: CLIENT_ID,
                    taskType: "RUOKA",
                    timeOfDay: ruokaTask.timeOfDay,
                    description: ruokaTask.description
                };
                
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>üì§ VAIHE 2: Kuittaus l√§hetys</h3>`;
                results.innerHTML += `<p><strong>Payload:</strong></p>`;
                results.innerHTML += `<pre>${JSON.stringify(ackPayload, null, 2)}</pre>`;
                
                const ackResponse = await fetch(NEW_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        apiKey: API_KEY,
                        action: "acknowledge",
                        ...ackPayload
                    })
                });
                
                const ackResult = await ackResponse.text();
                results.innerHTML += `<p><strong>Kuittaus vastaus status:</strong> ${ackResponse.status}</p>`;
                results.innerHTML += `<p><strong>Kuittaus vastaus:</strong></p>`;
                results.innerHTML += `<pre>${ackResult}</pre>`;
                
                let ackJson;
                try {
                    ackJson = JSON.parse(ackResult);
                    if (ackJson.status === "OK") {
                        results.innerHTML += `<p style="color: green;">‚úÖ Kuittaus onnistui!</p>`;
                    } else {
                        results.innerHTML += `<p style="color: red;">‚ùå Kuittaus ep√§onnistui: ${ackJson.error || ackJson.message || "Tuntematon virhe"}</p>`;
                    }
                } catch (e) {
                    results.innerHTML += `<p style="color: red;">‚ùå Kuittaus vastaus ei ole validia JSON!</p>`;
                }
                results.innerHTML += `</div>`;
                
                // VAIHE 3: Odota hetki ja hae uudelleen
                console.log('‚è±Ô∏è VAIHE 3: Odota ja hae uudelleen...');
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>‚è±Ô∏è VAIHE 3: Odotetaan 2 sekuntia...</h3>`;
                results.innerHTML += `</div>`;
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // VAIHE 4: Hae tilanne kuittauksen j√§lkeen
                console.log('üîÑ VAIHE 4: Hae tilanne kuittauksen j√§lkeen...');
                const afterResponse = await fetch(`${NEW_API_URL}?clientID=${CLIENT_ID}&apiKey=${API_KEY}&_t=${Date.now()}`);
                const afterData = await afterResponse.json();
                
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>üîÑ VAIHE 4: Tilanne kuittauksen j√§lkeen</h3>`;
                results.innerHTML += `<p><strong>Status:</strong> ${afterResponse.status}</p>`;
                
                if (afterData.dailyTasks) {
                    results.innerHTML += `<p><strong>Teht√§v√§t kuittauksen j√§lkeen:</strong></p>`;
                    afterData.dailyTasks.forEach((task, index) => {
                        const ackStatus = task.isAckedToday ? "‚úÖ KUITATTU" : "‚ùå EI KUITATTU";
                        const isRuoka = task.type === "RUOKA";
                        const style = isRuoka ? 'style="background: yellow; font-weight: bold;"' : '';
                        results.innerHTML += `<p ${style}>${index + 1}. <strong>${task.type}</strong>: "${task.description}" (${task.timeOfDay}) - ${ackStatus}</p>`;
                    });
                } else {
                    results.innerHTML += `<p style="color: red;">‚ùå Ei dailyTasks dataa!</p>`;
                }
                results.innerHTML += `</div>`;
                
                // VAIHE 5: Analysoi muutos
                console.log('üìä VAIHE 5: Analysoi muutos...');
                const afterRuokaTask = afterData.dailyTasks?.find(task => task.type === "RUOKA");
                
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>üìä VAIHE 5: Analyysi</h3>`;
                
                if (ruokaTask && afterRuokaTask) {
                    results.innerHTML += `<p><strong>ENNEN:</strong> RUOKA isAckedToday = ${ruokaTask.isAckedToday}</p>`;
                    results.innerHTML += `<p><strong>J√ÑLKEEN:</strong> RUOKA isAckedToday = ${afterRuokaTask.isAckedToday}</p>`;
                    
                    if (ruokaTask.isAckedToday === false && afterRuokaTask.isAckedToday === true) {
                        results.innerHTML += `<p style="color: green; font-weight: bold;">‚úÖ ONNISTUI: isAckedToday muuttui false ‚Üí true</p>`;
                        results.innerHTML += `<p style="color: green;">üëç Backend toimii oikein - ongelma on frontend UI p√§ivityksess√§!</p>`;
                    } else if (ruokaTask.isAckedToday === afterRuokaTask.isAckedToday) {
                        results.innerHTML += `<p style="color: red; font-weight: bold;">‚ùå ONGELMA: isAckedToday ei muuttunut</p>`;
                        if (afterRuokaTask.isAckedToday === false) {
                            results.innerHTML += `<p style="color: red;">üêõ Backend ei tallenna kuittausta oikein!</p>`;
                        } else {
                            results.innerHTML += `<p style="color: orange;">ü§î RUOKA oli jo kuitattu aikaisemmin</p>`;
                        }
                    }
                    
                    if (afterRuokaTask.acknowledgmentTimestamp) {
                        results.innerHTML += `<p><strong>Kuittausaika:</strong> ${afterRuokaTask.acknowledgmentTimestamp}</p>`;
                    }
                } else {
                    results.innerHTML += `<p style="color: red;">‚ùå Ei voitu verrata RUOKA teht√§vi√§!</p>`;
                }
                
                results.innerHTML += `</div>`;
                
                // VAIHE 6: Frontend suositukset
                results.innerHTML += `<div class="step">`;
                results.innerHTML += `<h3>üí° VAIHE 6: Suositukset</h3>`;
                
                if (afterRuokaTask?.isAckedToday === true) {
                    results.innerHTML += `<p style="color: green;">‚úÖ <strong>Backend toimii:</strong> Kuittaus tallentuu oikein</p>`;
                    results.innerHTML += `<p>üîß <strong>Frontend ongelma:</strong> UI ei p√§ivity kuittauksen j√§lkeen</p>`;
                    results.innerHTML += `<p>üõ†Ô∏è <strong>Korjaukset tarvitaan:</strong></p>`;
                    results.innerHTML += `<ul>`;
                    results.innerHTML += `<li>Blazor komponentin StateHasChanged() kutsuminen</li>`;
                    results.innerHTML += `<li>API vastauksen oikea k√§sittely</li>`;
                    results.innerHTML += `<li>TaskField.razor p√§ivityslogiikka</li>`;
                    results.innerHTML += `</ul>`;
                } else {
                    results.innerHTML += `<p style="color: red;">‚ùå <strong>Backend ongelma:</strong> Kuittaus ei tallennu</p>`;
                    results.innerHTML += `<p>üõ†Ô∏è <strong>Korjaukset tarvitaan Google Apps Scriptiss√§:</strong></p>`;
                    results.innerHTML += `<ul>`;
                    results.innerHTML += `<li>acknowledgeWeeklyTask_() funktio</li>`;
                    results.innerHTML += `<li>isTaskAckedToday_() funktio</li>`;
                    results.innerHTML += `<li>Kuittaukset sheet rakenne</li>`;
                    results.innerHTML += `</ul>`;
                }
                
                results.innerHTML += `</div>`;
                
            } catch (error) {
                console.error('‚ùå Virhe debuggauksessa:', error);
                results.innerHTML += `<div class="step error">`;
                results.innerHTML += `<h3>‚ùå Virhe debuggauksessa</h3>`;
                results.innerHTML += `<p>${error.message}</p>`;
                results.innerHTML += `<pre>${error.stack}</pre>`;
                results.innerHTML += `</div>`;
            }
        }
        
        // Aloita debug automaattisesti
        debugFullAcknowledgmentFlow();
    </script>
</body>
</html>