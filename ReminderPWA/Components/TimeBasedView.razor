@using ReminderTabletNew2.Models
@using ReminderTabletNew2.Services
@inject Microsoft.JSInterop.IJSRuntime JS
@implements IDisposable

<div class="mobile-container @GetViewCssClass()">
    <!-- Header Section -->
    <DateTimeWeather CurrentTime="@CurrentTime" 
                     TimeOfDayText="@GetTimeOfDayText()" 
                     Weather="@ApiResponse?.Weather" />

    <!-- Content Area -->
    <div class="content-area">
        @* Viestikentt√§ n√§kyy vain kun on oikea viesti *@
        @if (!string.IsNullOrEmpty(GetContextualMessage()))
        {
            <MessageNotification Message="@GetContextualMessage()" 
                               MessageTimestamp="@GetMessageTimestamp()" 
                               IsNewMessage="@IsNewMessage" />
        }

        @* Teht√§v√§kent√§t erillisess√§ komponentissa *@
        <TaskField 
            Tasks="GetFilteredTasks()" 
            TimeOfDayText="@GetTimeOfDayText()" 
            NextMealType="@ApiResponse?.NextMealType"
            NextMealTime="@ApiResponse?.NextMealTime"
            MealOptions="@ApiResponse?.MealOptions"
            OnTaskAcknowledge="HandleTaskAcknowledge" />

        @* T√§rke√§ viesti (jos on) *@
        <ImportantBanner ImportantMessage="@ApiResponse?.ImportantMessage" />
        
        @* Poistettu erillinen "Puuhaa nyt" -kortti. Puuhaa n√§ytet√§√§n teht√§v√§korttina. *@

        @* Poistettu erillinen ruokaehdotus-kortti; ehdotus n√§ytet√§√§n RUOKA-teht√§v√§n rivill√§ *@

        @* P√§iv√§n valokuva *@
        <DailyPhoto ApiPhotoUrl="@ApiResponse?.DailyPhotoUrl"
                   ApiPhotoCaption="@ApiResponse?.DailyPhotoCaption"
                   FallbackUrl="@GetFallbackPhotoUrl()"
                   OnPhotoClick="OnPhotoClickHandler" />
        
        @* Footer toiminnot *@
        <div class="footer-wrapper">
            <ActionFooter OnNavigateToWeekly="OnNavigateToWeekly"
                         OnNavigateToContacts="OnNavigateToContacts"
                         OnStartExercise="OnStartExercise"
                          OnSendMessage="ShowTelegramFromFooter"
                           OnClearCache="ClearCacheFromFooter"
                          ShowSendMessage="true" />
        </div>
    </div>
</div>

<ImageModal IsVisible="@showImageModal" 
            ImageSrc="@modalImageSrc" 
            ImageAlt="@modalImageAlt"
            ImageTitle="P√§iv√§n kuvamuisto"
            ImageCaption="@modalImageCaption"
            OnClose="CloseImageModal" />

@code {
    [Parameter] public required ViewMode TimeOfDay { get; set; }
    [Parameter] public required DateTime CurrentTime { get; set; }
    [Parameter] public ReminderApiResponse? ApiResponse { get; set; }
    [Parameter] public EventCallback<TaskAckRequest> OnAcknowledgeTask { get; set; }
    [Parameter] public EventCallback OnNavigateToWeekly { get; set; }
    [Parameter] public EventCallback OnNavigateToContacts { get; set; }
    [Parameter] public EventCallback OnStartExercise { get; set; }
    [Parameter] public EventCallback OnShowTelegram { get; set; }
    [Parameter] public EventCallback OnRequestReload { get; set; }
    [Parameter] public bool IsNewMessage { get; set; } = false;

    public enum ViewMode
    {
        Morning,     // 06:00-11:00
        Day,         // 11:00-16:00
        Evening,     // 16:00-21:00
        Night        // 21:00-06:00
    }

    public class TaskAckRequest
    {
        public string TaskType { get; set; } = "";
        public string TimeOfDay { get; set; } = "";
        public string Description { get; set; } = "";
    }

    // Image modal state
    private bool showImageModal = false;
    private string modalImageSrc = "";
    private string modalImageAlt = "";
    private string modalImageCaption = "";

    private string GetViewCssClass()
    {
        return TimeOfDay switch
        {
            ViewMode.Morning => "morning-view",
            ViewMode.Day => "day-view", 
            ViewMode.Evening => "evening-view",
            ViewMode.Night => "night-view",
            _ => "morning-view"
        };
    }

    private string GetTimeOfDayText()
    {
        return TimeOfDay switch
        {
            ViewMode.Morning => "Aamu",
            ViewMode.Day => "P√§iv√§",
            ViewMode.Evening => "Ilta", 
            ViewMode.Night => "Y√∂",
            _ => "Aamu"
        };
    }

    private string GetMessageTimestamp()
    {
        return TimeOfDay switch
        {
            ViewMode.Morning => "Viesti saapui 08:00",
            ViewMode.Day => "Viesti saapui 12:00", 
            ViewMode.Evening => "Viesti saapui 16:00",
            ViewMode.Night => "Viesti saapui 21:00",
            _ => "Viesti saapui juuri"
        };
    }

    private string GetContextualMessage()
    {
        // KORJAUS: K√§yt√§ ensisijaisesti API:sta tulevaa √§lykk√§ist√§ tervehdyst√§
        if (!string.IsNullOrWhiteSpace(ApiResponse?.Greeting))
        {
            return ApiResponse!.Greeting;
        }

        // Toiseksi: Vanha LatestReminder
        var message = ApiResponse?.LatestReminder;
        if (!string.IsNullOrEmpty(message))
        {
            // Est√§ "Tervetuloa!" ja muut ei-toivotut viestit
            if (!message.Contains("Tervetuloa") && 
                !message.Contains("Welcome") && 
                !message.Contains("tervetuloa"))
            {
                return message;
            }
        }

        // Fallback: √Ñl√§ n√§yt√§ kuvan kuvausta viestikent√§ss√§
        return string.Empty;
    }

    private string GetActivitySuggestion() => string.Empty; // Ei n√§ytet√§ fallback-teksti√§ (PUUHAA tulee teht√§viss√§)

    // Ei erillist√§ activity-korttia en√§√§

    private bool HasMealSuggestions() => (ApiResponse?.MealOptions?.Any() ?? false);

    private string GetApiString(string name) => string.Empty; // ei tarvita en√§√§
    private IEnumerable<string> GetApiStringArray(string name) => Enumerable.Empty<string>();

    private string GetFallbackPhotoUrl()
    {
        var profile = ApiResponse?.ProfilePhoto?.Url;
        if (!string.IsNullOrWhiteSpace(profile)) return profile!;
        var firstWeekly = ApiResponse?.WeeklyPhotos?.FirstOrDefault()?.Url;
        return firstWeekly ?? string.Empty;
    }

    private IEnumerable<DailyTask> GetFilteredTasks()
    {
        if (ApiResponse?.DailyTasks == null) return [];
        
        // Filter tasks based on time of day
        return ApiResponse.DailyTasks.Where(task => IsTaskRelevantForTime(task));
    }

    private void OnPhotoClickHandler(DailyPhoto.PhotoClickArgs args)
    {
        OpenImageModal(args.ImageUrl, args.Caption);
    }

    private void OpenImageModal(string imageSrc, string caption)
    {
        modalImageSrc = imageSrc;
        modalImageAlt = caption;
        modalImageCaption = caption;
        showImageModal = true;
        StateHasChanged();
    }

    private void CloseImageModal()
    {
        showImageModal = false;
        StateHasChanged();
    }

    private async Task ShowTelegramFromFooter()
    {
        if (OnShowTelegram.HasDelegate)
        {
            await OnShowTelegram.InvokeAsync();
        }
    }

    private async Task ClearCacheFromFooter()
    {
        try
        {
            await JS.InvokeVoidAsync("localStorage.removeItem", "lastApiResponse");
            await JS.InvokeVoidAsync("localStorage.removeItem", "recentAcks");
            await JS.InvokeVoidAsync("console.log", "Cache cleared from footer");
            if (OnRequestReload.HasDelegate)
            {
                await OnRequestReload.InvokeAsync();
            }
        }
        catch {}
    }

    private bool IsTaskRelevantForTime(DailyTask task)
    {
        // N√§ytet√§√§n RUOKA ja PUUHAA aina kaikissa n√§kymiss√§ (konsistentti linja)
        var upperType = (task.Type ?? "").ToUpperInvariant();
        if (upperType == "RUOKA" || upperType == "PUUHAA") return true;

        // Ensisijaisesti k√§ytet√§√§n task.TimeOfDay API:sta
        if (!string.IsNullOrEmpty(task.TimeOfDay))
        {
            var taskTimeOfDay = task.TimeOfDay;
            
            return TimeOfDay switch
            {
                ViewMode.Morning => taskTimeOfDay.Equals("Aamu", StringComparison.OrdinalIgnoreCase),
                ViewMode.Day => taskTimeOfDay.Equals("P√§iv√§", StringComparison.OrdinalIgnoreCase), 
                ViewMode.Evening => taskTimeOfDay.Equals("Ilta", StringComparison.OrdinalIgnoreCase),
                ViewMode.Night => taskTimeOfDay.Equals("Y√∂", StringComparison.OrdinalIgnoreCase),
                _ => true
            };
        }
        
        // Fallback: k√§ytet√§√§n task.Type:a (vanha logiikka)
        var taskType = task.Type?.ToUpper() ?? "";
        
        return TimeOfDay switch
        {
            ViewMode.Morning => taskType.Contains("RUOKA") || taskType.Contains("L√Ñ√ÑKKEET") || taskType.Contains("AAMU"),
            ViewMode.Day => taskType.Contains("LOUNAS") || taskType.Contains("P√ÑIV√Ñ") || taskType.Contains("RUOKA") || taskType.Contains("L√Ñ√ÑKKEET") || taskType.Contains("ASIAT") || (!taskType.Contains("ILTA") && !taskType.Contains("Y√ñ")),
            ViewMode.Evening => taskType.Contains("RUOKA") || taskType.Contains("L√Ñ√ÑKKEET") || taskType.Contains("PUUHAA") || taskType.Contains("ILTA") || taskType.Contains("P√ÑIV√ÑLLINEN"),
            ViewMode.Night => taskType.Contains("ILTAPALA") || taskType.Contains("L√Ñ√ÑKKEET") || taskType.Contains("Y√ñ"),
            _ => true
        };
    }
    
    private async Task HandleTaskAcknowledge(DailyTask task)
    {
        var timeOfDay = !string.IsNullOrEmpty(task.TimeOfDay) ? task.TimeOfDay : GetTimeOfDayText();

        Console.WriteLine($"üîß Acknowledging task: {task.Type} - '{task.Description}' - Original TimeOfDay: '{task.TimeOfDay}' - Using: '{timeOfDay}'");

        // Optimistinen UI: merkitse heti kuitatuksi, jotta nappi vaihtuu visuaalisesti
        try
        {
            task.IsAckedToday = true;
            task.AcknowledgmentTimestamp = DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm:ss.fffZ");
            StateHasChanged();
        }
        catch { /* ignore */ }

        await OnAcknowledgeTask.InvokeAsync(new TaskAckRequest {
            TaskType = task.Type,
            TimeOfDay = timeOfDay,
            Description = task.Description ?? ""
        });
    }

    // PARAS K√ÑYT√ÑNT√ñ: IDisposable pattern
    public void Dispose()
    {
        // Tulevaisuudessa: unsubscribe events, cancel timers, dispose resources
        // Esim: timer?.Dispose();
    }
} 