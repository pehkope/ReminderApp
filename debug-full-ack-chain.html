<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>üîç T√ÑYDELLINEN KUITTAUS DEBUG</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f0f0; }
        .step { background: white; margin: 10px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .loading { color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <h1>üîç T√ÑYDELLINEN KUITTAUS DEBUG KETJU</h1>
    <p><strong>Testataan koko kuittausketju vaihe vaiheelta</strong></p>

    <div id="results"></div>

    <button onclick="startFullDebug()">üöÄ ALOITA T√ÑYDELLINEN DEBUG</button>
    <button onclick="clearResults()">üóëÔ∏è TYHJENN√Ñ</button>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxpQyWZkyiMXJIoJrHLEGZPOm-TgqBlW3ftSkmZTuDK6Ya-OZOlKkPW3RNTRQetNeNb/exec';
        const API_KEY = 'reminder-tablet-2024';
        const CLIENT_ID = 'mom';

        function addResult(title, content, type = 'step') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function startFullDebug() {
            clearResults();
            addResult('üöÄ ALOITETAAN T√ÑYDELLINEN KUITTAUS DEBUG', '<div class="loading">Testataan koko kuittausketju...</div>');

            try {
                // VAIHE 1: Hae alkutilanne
                addResult('üìã VAIHE 1: Hae alkutilanne', '<div class="loading">Haetaan nykyiset teht√§v√§t...</div>');
                const initialData = await fetchCurrentTasks();
                
                // VAIHE 2: Analysoi teht√§v√§t
                addResult('üîç VAIHE 2: Analysoi teht√§v√§t', analyzeTasksHTML(initialData));
                
                // VAIHE 3: Valitse kuittausta varten
                const taskToAck = selectTaskForAcknowledgment(initialData);
                if (!taskToAck) {
                    addResult('‚ùå VIRHE: Ei kuittaukseen sopivia teht√§vi√§', 'Ei l√∂ytynyt RUOKA tai L√Ñ√ÑKKEET teht√§vi√§ jotka eiv√§t ole viel√§ kuitattu', 'error');
                    return;
                }

                addResult('üéØ VAIHE 3: Valittu kuittaukseen', 
                    `<strong>Teht√§v√§:</strong> ${taskToAck.type}<br>
                     <strong>Aika:</strong> ${taskToAck.timeOfDay}<br>
                     <strong>Kuvaus:</strong> ${taskToAck.description}<br>
                     <strong>Kuitattu:</strong> ${taskToAck.isAckedToday}`);

                // VAIHE 4: L√§het√§ kuittaus
                addResult('üì§ VAIHE 4: L√§het√§ kuittaus', '<div class="loading">L√§hetet√§√§n kuittauspyynt√∂...</div>');
                const ackResponse = await sendAcknowledgment(taskToAck);
                
                // VAIHE 5: Odota hetki
                addResult('‚è±Ô∏è VAIHE 5: Odota propagoitumista', '<div class="loading">Odotetaan 3 sekuntia...</div>');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // VAIHE 6: Hae lopputilanne
                addResult('üìã VAIHE 6: Hae lopputilanne', '<div class="loading">Haetaan p√§ivitetyt teht√§v√§t...</div>');
                const finalData = await fetchCurrentTasks();
                
                // VAIHE 7: Vertaa tilannetta
                addResult('üîÑ VAIHE 7: Vertaa tilannetta', compareTaskStates(initialData, finalData, taskToAck));
                
                // VAIHE 8: Lopputulema
                const success = analyzeSuccess(initialData, finalData, taskToAck);
                addResult('üèÅ LOPPUTULEMA', success.message, success.type);

            } catch (error) {
                addResult('üí• KRIITTINEN VIRHE', `<pre>${error.message}\n${error.stack}</pre>`, 'error');
            }
        }

        async function fetchCurrentTasks() {
            const url = `${GAS_URL}?clientID=${CLIENT_ID}&apiKey=${API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            
            addResult('üì• GET vastaus', `<pre>Status: ${response.status}\n${JSON.stringify(data, null, 2)}</pre>`);
            return data;
        }

        function analyzeTasksHTML(data) {
            if (!data.dailyTasks || data.dailyTasks.length === 0) {
                return '<div class="error">‚ùå Ei p√§ivitt√§isi√§ teht√§vi√§!</div>';
            }

            let html = `<strong>L√∂ytyi ${data.dailyTasks.length} teht√§v√§√§:</strong><br><br>`;
            data.dailyTasks.forEach((task, index) => {
                const status = task.isAckedToday ? '‚úÖ KUITATTU' : '‚è≥ ODOTTAA';
                html += `<strong>${index + 1}. ${task.type}</strong> (${task.timeOfDay})<br>`;
                html += `   Kuvaus: ${task.description}<br>`;
                html += `   Status: ${status}<br><br>`;
            });

            return html;
        }

        function selectTaskForAcknowledgment(data) {
            if (!data.dailyTasks) return null;
            
            // Etsi ensimm√§inen ei-kuitattu RUOKA tai L√Ñ√ÑKKEET teht√§v√§
            return data.dailyTasks.find(task => 
                (task.type === 'RUOKA' || task.type === 'L√Ñ√ÑKKEET') && 
                !task.isAckedToday
            );
        }

        async function sendAcknowledgment(task) {
            const url = `${GAS_URL}?action=acknowledge&apiKey=${API_KEY}&clientID=${CLIENT_ID}&taskType=${task.type}&timeOfDay=${task.timeOfDay}&description=${encodeURIComponent(task.description)}&timestamp=${new Date().toISOString()}`;
            
            addResult('üì§ KUITTAUS URL', `<pre>${url}</pre>`);
            
            const response = await fetch(url);
            const data = await response.json();
            
            addResult('üì• KUITTAUS vastaus', `<pre>Status: ${response.status}\n${JSON.stringify(data, null, 2)}</pre>`, 
                data.status === 'OK' ? 'success' : 'error');
            
            return data;
        }

        function compareTaskStates(initial, final, ackedTask) {
            let html = '<strong>VERTAILU:</strong><br><br>';
            
            const initialTask = initial.dailyTasks?.find(t => 
                t.type === ackedTask.type && 
                t.timeOfDay === ackedTask.timeOfDay && 
                t.description === ackedTask.description
            );
            
            const finalTask = final.dailyTasks?.find(t => 
                t.type === ackedTask.type && 
                t.timeOfDay === ackedTask.timeOfDay && 
                t.description === ackedTask.description
            );

            html += `<strong>Kuitattu teht√§v√§: ${ackedTask.type} (${ackedTask.timeOfDay})</strong><br>`;
            html += `Kuvaus: ${ackedTask.description}<br><br>`;
            
            if (initialTask && finalTask) {
                html += `<strong>ENNEN:</strong> isAckedToday = ${initialTask.isAckedToday}<br>`;
                html += `<strong>J√ÑLKEEN:</strong> isAckedToday = ${finalTask.isAckedToday}<br><br>`;
                
                if (initialTask.isAckedToday === false && finalTask.isAckedToday === true) {
                    html += '<div class="success">‚úÖ MUUTOS ONNISTUI!</div>';
                } else if (initialTask.isAckedToday === finalTask.isAckedToday) {
                    html += '<div class="error">‚ùå EI MUUTOSTA!</div>';
                } else {
                    html += '<div class="warning">‚ö†Ô∏è ODOTTAMATON MUUTOS!</div>';
                }
            } else {
                html += '<div class="error">‚ùå Teht√§v√§√§ ei l√∂ytynyt vertailuun!</div>';
            }

            return html;
        }

        function analyzeSuccess(initial, final, ackedTask) {
            const initialTask = initial.dailyTasks?.find(t => 
                t.type === ackedTask.type && 
                t.timeOfDay === ackedTask.timeOfDay && 
                t.description === ackedTask.description
            );
            
            const finalTask = final.dailyTasks?.find(t => 
                t.type === ackedTask.type && 
                t.timeOfDay === ackedTask.timeOfDay && 
                t.description === ackedTask.description
            );

            if (!initialTask || !finalTask) {
                return {
                    type: 'error',
                    message: '‚ùå KRIITTINEN VIRHE: Teht√§v√§ katosi vertailun aikana!'
                };
            }

            if (initialTask.isAckedToday === false && finalTask.isAckedToday === true) {
                return {
                    type: 'success',
                    message: 'üéâ KUITTAUS ONNISTUI! Backend p√§ivittyi oikein. Jos UI ei p√§ivity, ongelma on frontendiss√§.'
                };
            } else if (initialTask.isAckedToday === finalTask.isAckedToday) {
                return {
                    type: 'error',
                    message: '‚ùå KUITTAUS EP√ÑONNISTUI: Backend ei p√§ivittynyt. Ongelma Google Apps Scriptiss√§ tai Google Sheetsist√§.'
                };
            } else {
                return {
                    type: 'warning',
                    message: '‚ö†Ô∏è ODOTTAMATON TILANNE: Jotain meni pieleen vertailussa.'
                };
            }
        }
    </script>
</body>
</html>